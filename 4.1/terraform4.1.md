## 4 프로바이더

> 프로바이더는 플러그인 형태로 테라폼에 결합되어 대상이되는 클라우드, SaaS, 기타 서비스 API를 사용해 동작을 수행한다.

- 프로바이더는 테라폼이 관리하는 리소스 유형과 데이터 소스를 사용할 수 있도록 연결한다.
- 즉, 테라폼은 프로바이더 없이는 어떤 종류의 인프라와 서비스도 관리할 수 없다.
- 대부분 프로바이더는 대상 인프라 환경이나 서비스 환경에 대해 리소스를 관리하므로, 프로바이더를 구성할 때는 대상과의 연결과 인증에 필요한 정보가 제공되어야 한다.

### 4.1 프로바이더 구성

> 실습 위주로 다룬 local 프로바이더처럼 프로바이더를 위한 별도 구성이 필요하지 않은 경우도 있지만, AWS와 같은 클라우드 프로바이더의 경우 AWS 자격증명 정보와 리전 이름 등을 정의하기도 한다.

#### 4.1.1 로컬 이름과 프로바이더 지정

> `terraform` 블록의 r`equired_providers` 블록 내에 **<로컬 이름>** = **{}**으로 여러 개의 프로바이더를 정의할 수 있다.
> 여기서 사용되는 **로컬 이름**은 테라폼 모듈 내에서 고유해야 한다.
> **로컬 이름**과 리소스 접두사는 독립적으로 선언되며, 각 프로바이더의 소스 경로가 지정되면 프로바이더의 고유 접두사가 제공된다.

- 만약 동일한 접두사를 시용하는 프로바이더가 선언되는 경우 **로컬 이름**을 달리해 관련 리소스에서 어떤 프로바이더를 사용하는지 명시적으로 지정할 수 있다.
- 다음 main.tf에서처럼 동일한 http이름을 사용하는 다수의 프로바이더가 있는 경우 각 프로바이더에 고유한 이름을 부여하고 리소스와 데이터 소스에 어떤 프로바이더를 사용할지 provider 인수에 명시한다. 단 동일한 source에 대해 다수의 정의는 불가능하다.

```
### 4.1.1
#### 동일한 http 접두사를 사용하는 다수의 프로바이더 사용 정의
terraform {
  required_providers {
    architect-http = {
        source = "architect-team/http"
        version = "~> 3.0"
    }
    http = {
      source = "hashicorp/http"
    }
    aws-http = {
        source = "terraform-aws-modules/http"
    }
 }
}

data "http" "example" {
    provider = aws-http
    url = "https://checkpoint-api.hashicorp.com/v1/check/terraform"

    request_headers = {
        Accept = "application/json"
    }
}
```

#### 4.1.2 단일 프로바이더의 다중 정의

> 동일한 프로바이더를 사용하지만 다른 조건을 갖는 경우, 사용되는 리소스마다 별도로 선언된 프로바이더를 지정해야 하는 경우가 있다.

예를들어,

- AWS 프로바이더를 사용하는데 서로 다른 권한의 IAM을 갖는 Access ID 또는 대상 리전을 지정해야 하는 경우다. 이때는 프로바이더 선언에서 alias를 명시하고 사용하는 리소스와 데이터 소스에서는 provider 메타인수를 사용해 특정 프로바이더를 지정할 수 있다.
- provider 메타인수에 지정되지 않은 경우 alias가 없는 프로바이더가 기본 프로바이더로 동작한다.

예제1) 리전을 다르게 구성한 AWS 프로바이더를 aws_instance에 지정하는 방법이다.

```
### 4.1.2
provider "aws" {
    region = "us-west-1"
}

provider "aws" {
    alias = "seoul"
    region = "ap-northeast-2"
}

resource "aws_instance" "app_server" {
    provider = aws.seoul
    ami = "ami-0c55b159cbfafe1f0"
    instance_type = "t3.micro"
}
```

#### 4.1.3 프로바이더 요구사항 정의

> 테라폼 실행 시 요구되는 프로바이더 요구사항은 terraform 블록의 required_providers 블록에 여러 개를 정의할 수 있다.
> source에는 프로바이더 다운로드 경로를 지정하고 version에는 버전 제약을 명시한다.

```
### 4.1.3
terraform {
  required_providers {
    <프로바이더 로컬 이름> =  {
        source = [<호스트 수조>/]<네임스페이스>/<유형>
        version = [<버전 제약>]
    }
    ...
  }
}
```

- 호스트 주소 : 프로바이더를 배포하는 주소로서 기본값은 registry.terraform.io이다.
- 네임스페이스 : 지정된 레지스트리 내에서 구분하는 네임스페이스로, 공개된 레지스트리 및 HCP TF / TFE의 비공개 레지스트리의 프로바이더를 게시하는 조직을 의미한다.
- 유형 : 프로바이더에서 관리되는 플랫폼이나 서비스 이름으로 일반적으로는 접두사와 일치하나 일부 예외가 있을 수 있다.

> 프로바이더는 기능이나 조건이 시간이 지남에 다라 변경될 수 있다. 이 같은 변경에 특정 버전을 명시하거나 버전 호환성을 정의할 때, version에 명시할 수 있다. 이 값이 생략되는 경우 `terraform init`을 하는 당시의 가장 최신 버전으로 선택됨.

`버전의 상세 내용은 3.3장의 버전 설정 확인`

#### 4.1.4 프로바이더 설치

> 테라폼을 실행하기 전 `terraform init` 명령을 통해 정의된 프로바이더를 다운로드, 복사, 캐시에서 읽어오게 된다.

- 항상 지정된 구성에 대해 동일한 프로바이더를 설치하도록 하려면 테라폼 구성에 사용되는 프로바이더에 대해 명시적으로 terraform 블록에 정의하거나 .terraform.lock.hcl 잠금 파일을 코드 저장소에 공유하는 방안이 요구된다.
- 2장에서 살펴본 것처럼 required_providers에 지정된 프로바이더가 있는 경우 코드상 구성에서 사용 여부에 관계없이 프로바이더를 다운로드하게 되고, required_providers에 지정하지 않더라도 테라폼 구성 코드상에서 사용된 프로바이더는 테라폼에서 추론해 최신 버전의 프로바이더를 다운로드한다.

#### 4.1.5 프로바이더 간 전환 여부

> 클라우드 대상으로 테라폰을 사용하는 경우 다른 클라우드 프로바이더로 전환이 가능할까? -> 불가능하다.
> 테라폼은 인프라에 대한 단일 프로비저닝 도구로 사용되지만 대상이 되는 환경에는 서로 다른 API로 구현된 프로바이더가 제공된다.

- 비록 AWS의 구성을 Azure로 Azure의 구성을 GCP로 전환하는건 불가능 하지만, IaC로서의 테라폼의 득성이 작업 효율을 높여준다.

`프로바이더간 대응되는 리소스 예시`
|Resource|AWS|GCP|
|---|---|---|
|VPC, Subnets, Firewall| aws_vpc aws_subnet|google_compute_network google_compute_subnetwork google_compute_firewall|
|Load Balancer| aws_alb aws_security_group|google_compute_backend_service google_compute_target_http_proxy google_compute_global_forwarding_rule|
|Virtual Machine| aws_instance|google_compute_instance|
|Database| aws_db_instance|google_sql_database_instance|

### 4.2 프로바이더 에코시스템

> 테라폼의 에코시스템은 사용자가 사용하는 방식과 구조에 테라폼을 적용할 수 있도록 설계된다.
> 에코시스템을 위한 테라폼 통합은 워크플로 파트너와 인프라 파트너로 나뉜다.
> `워크 플로 파트너`는 테라폼 코드를 작성하고 실행 및 HCP TF / TFE와 연계하여 동작하는 방법을 제공하는 항목으로 이루어져 있다. 대표적으로 테라폼 구성을 관리하기 위한 VCS를 제공하는 깃허브, 깃랩, 비트버킷, 애저 데브옵스가 이 항목에 해당한다.

> `프로바이더`의 경우 `인프라 파트너` 항목에 해당한다.
> `인프라 파트너`는 사용자가 테라폼으로 대상 플랫폼의 API로 상호작용 가능한 리소스를 관리할 수 있도록 한다.
> 예를들어 VCS의 워크플로 파트너인 깃허브는 테라폼으로 프로비저닝 가능한 인프라 파트너이기도 하다.
> 사용자는 테러폼을 사용허여 깃허브의 사용자, 팀, 저장소, 브랜치 등을 프로비저닝하고 관리할 수 있다.

**인프라 파트너의 분류와 프로바이더 대상**

- 퍼블릭 클라우드 : IaaS, SaaS 및 PaaS를 포함한 다양한 서비스를 제공하는 대규모 글로벌 클라우드 제공
- 컨테이너 오케스트레이션 : 컨테이너 프로비저닝 및 배포를 지원
- IaaS(Infrastructure as a Service) : 가상 머신, 네트워크, 스토리지와 같은 솔루션을 제공하는 인프라 및 IaaS 제공
- 보안 및 인증 : 인증 및 보안 모니터링 플랫폼
- 자산 관리 : 소프트웨어 라이선스, 하드웨어 자산 및 클라우드 리소스를 비롯한 주요 조직 및 IT 리소스의 자산관리를 제공
- CI/CD : 지속적 통합/지속적 제공/배포
- 로깅 및 모니터닝 : 로거, 측정 도구 및 모니터링 서비스와 같은 서비스를 구성하고 관리하는 기능
- 유틸리티 : 임의 값 생성, 파일 생성, http 상호 작용 및 시간 기반 리소스와 같은 도우미 기능
- 클라우드 자동화 : 구성 관리와 같은 전문화된 클라우드 인프라 자동화 관리 기능
- 데이터 관리 : 데이터 센터 스토리지, 백업 및 복구 솔루션
- 네트워킹 : 라우팅, 스위칭, 방화벽 및 SD-WAN 솔루션과 같은 네트워크별 하드웨어 및 가상화된 제품과 통합
- VCS(버전 제어 시스템) : Terraform 내에서 VCS 프로젝트, 팀 및 리포지터리에 중점
- 통싱 및 메시징 : 통신, 이메일 및 메시징 플랫폼과 통합
- 데이터베이스 : 데이터베이스 리소스를 프로비저닝하고 구성하는 기능
- PaaS(Platform as a Service) : 다양한 하드웨어, 소프트웨어 및 애플리케이션 개발 도구를 제공하는 플랫폼 및 PaaS
- 웹 서비스 : 웹 호스팅, 웹 성능, CDN 및 DNS 서비스

#### 4.2.1 퍼블릭 클라우드(+IaaS, PaaS) 프로바이더

> 인프라 환경이 제공하는 다수의 리소스를 IaC 환경으로 전환하면, 반복적인 구축의 자동화 및 템플릿 제공이 가능해 테라폼을 포함한 많은 IaC도구가 클라우드 프로비저닝에 활용된다.

##### 퍼블릭 클라우드

- AWS
- Azure
- GCP
- IBM Cloud
- Oracle Cloud
- Alibaba Cloud
- Naver Cloud
- Samsung Cloud
  이 프로바이더를 제공

> 퍼블릭 클라우드는 설계 단계에서 대부분의 리소스 구성에 대한 API 기반을 고현하기 때문에 테라폼으로 풍부한 리소스 구성이 가능함.

##### 프라이빗 클라우드/VM

- Azure Stack (IaaS)
- OpenStack (IaaS)
- Equinix가 데이터 센터 환경을 테라폼 프로바이더로 제공
- VMware의 vSphere 환경이나 NSXT, Nutanix 같은 HCI 플랫폼도 테라폼 프로바이더를 제공하므로 IaC 방식으로 관리할 수 있다.

#### 4.2.2 컨테이너 오케스트레이터

> 컨테이너 오케스트레이터는 다수의 호스트 환경에서 컨테이너를 배포 및 관리하는 도구
> 대표적으로 하시코프의 노마드를 비롯해 쿠버네티스, 랜처, 탄주를 예로 들 수 있다.

- 최신 오케스트레이션 도구들은 저마다의 IaC 방식을 지원하지만 테라폼 같은 상태 기반 동작을 수행하지 않음
- 그러므로 테라폼이 제공하는 코드적인 기능과 함수 및 변수를 기반으로 기존 IaC 방식 대비 테라폼의 구성 방식을 활용할 수 있고, 배포 환경이 되는 클라우드와 IaaS 환경을 테러폼으로 구성한 후 애플리케이션을 바로 배포할 수 있는 워크플로를 계획할 수 있다.

#### 4.2.3 SaaS 서비스

> SaaS 서비스는 사용하고자 하는 소프트웨어의 설치, 구성, 관리에 대한 부담을 줄이고 주문형으로 빠른 시간 내에 원하는 자원을 획득할 수 있다는 장점이 있다.

> 반면 설치형이 해당 솔루션만 설치하면 되는 데 비해 SaaS 서비스는 개별 계정 관리, 접근 관리, 네트워크 구성 등 각 SaaS 서비스마다 독립적으로 제공하는 리소스에 대한 관리가 필요하며, 이 경우 테라폼의 IaC 특성을 활용해 구성 및 관리가 가능하다.

- 하시코프릐 SaaS 서비스인 HCP를 포함해 MongoDB Atlas, Confluent Cloud, Datadog, Redis Cloud, Okta 등 다양한 SaaS 형태 프로바이더가 제공되고 있다.

#### 4.2.4 기타 솔루션

> 인프라 환경의 F5, Cisco의 네트워크 장비, Fortinet, Palo Alto의 하드웨어 방화벽, Netapp 스토리지, Elastic Stack, Splunk, Newrelic, Grafana의 모니터링 도구 등 API를 제공하는 각 솔루션 또한 테라폼 프로바이더가 제공되어 솔루션에 대한 설정이 가능하고 여러 프로버이더를 사용하여 연계된 프로비저닝을 수행할 수 있다.
